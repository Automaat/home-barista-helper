name: Production Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Push to Production Branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
      deployments: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if production branch exists
        id: check_branch
        run: |
          if git ls-remote --heads origin production | grep production; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update production branch
        id: push
        run: |
          if [ "${{ steps.check_branch.outputs.exists }}" == "false" ]; then
            echo "Creating production branch from main"
            git checkout -b production
            git push -u origin production
            echo "action=created" >> $GITHUB_OUTPUT
          else
            echo "Updating production branch from main"
            git fetch origin production
            git checkout production
            git merge --ff-only origin/main || {
              echo "Fast-forward merge failed. Creating merge commit..."
              git merge -X theirs -m "chore: sync production with main" origin/main
            }
            git push origin production
            echo "action=updated" >> $GITHUB_OUTPUT
          fi
          echo "sha=$(git rev-parse production)" >> $GITHUB_OUTPUT

      - name: Wait for Cloudflare deployment
        run: |
          echo "‚è≥ Production branch ${{ steps.push.outputs.action }}"
          echo "üì¶ Commit: ${{ steps.push.outputs.sha }}"
          echo "üöÄ Cloudflare Pages will deploy automatically"
          echo ""
          echo "Check status at:"
          echo "  - Cloudflare Pages dashboard"
          echo "  - GitHub Actions deployments tab"

      - name: Check Cloudflare deployment status
        if: env.CLOUDFLARE_API_TOKEN != ''
        continue-on-error: true
        run: |
          echo "Waiting 30s for Cloudflare to start deployment..."
          sleep 30

          # Get latest deployment for production branch
          DEPLOYMENTS=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/home-barista-helper/deployments" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")

          LATEST_URL=$(echo "$DEPLOYMENTS" | jq -r '.result[0].url // empty')
          LATEST_STATUS=$(echo "$DEPLOYMENTS" | jq -r '.result[0].latest_stage.status // empty')

          if [ -n "$LATEST_URL" ]; then
            echo "‚úÖ Latest deployment: $LATEST_URL"
            echo "üìä Status: $LATEST_STATUS"
          else
            echo "‚ö†Ô∏è Could not fetch deployment info (check manually)"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
